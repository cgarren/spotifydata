<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js">
	</script>-->
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/brython@3.8.7/brython.min.js">
    </script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/brython@3.8.7/brython_stdlib.js">
    </script>
</head>

<body onload="brython()">

Hi there!

<script type="text/python">
#import requests
import datetime
import sys
import json
from urllib import parse
from browser import document, html, ajax
from browser.local_storage import storage

storage['access_token']='BQBewS1V8hHmT28UUGTMuni7nDq7z0Kq3Z8Xw3WsRSeW5lfxi51K3SmqzS8sqKovtR30SSO5hXARqYaUTQza_O9KJDxrbjsEumL5zpIelsl2hoGXCag7INX15BV8unPduxZa2r1i5qRqgnz8Fv-tHFnG7NFYmXeZFvplNAjJLcDXLLQid6nXnYxpoI0GaLn9hXJXUVx_DtnythS14oDOhSBxvQ'
storage['refresh_token']='AQBKVS0CL6-iGN1YTxZ8UXL8yhG3fIrvYOGyOtAYdppqPgt7MnjOV7kSKOfo1AP6GNywAhvu8pLg-MyX1pjPOa5mvfojYy68eGJWi7DXcySrtI9zzWQXjmxyYVvMoeHyAFE'
storage['last_refresh_time']='2020-03-05 15:33:41.695988'
storage['client_id']='fff2634975884bf88e3d3c9c2d77763d' #Your client id
storage['client_secret']='774857e7a6fa48d59c8cce1054181f01' #Your secret
storage['redirect_uri']='http://spotifydata.ml/'

def authenticateUser():
    def on_complete(req):
            if req.status == 200 or req.status == 0:
                document <= "User Authenticated!"
                document <= req.text
                document <= json.loads(req.text)
                storage['access_token'] = json.loads(req.text)['access_token']
                document <= str(json.loads(req.text)['access_token'])
            else:
                 document <= "Error in token refresh!"

    scopes = 'user-follow-read user-follow-modify user-read-private user-read-email streaming user-read-currently-playing user-modify-playback-state user-library-modify user-library-read user-top-read'

    data = {'client_id' : storage['client_id'], 'response_type' : 'token', 'redirect_uri' : storage['redirect_uri'], 'state' : 'test', 'scope' : scopes}
            
    url = "https://accounts.spotify.com/authorize?" + parse.urlencode(data)
    document <= url
    req = ajax.Ajax()
    req.bind('complete', on_complete)
    # send a GET request to the url
    req.open('GET', url, True) 
    # send data as a dictionary
    req.set_header('content-type', 'application/x-www-form-urlencoded')
    req.send(data)


def refreshAccessToken():
	last_refreshed_time = datetime.datetime.strptime(storage['last_refresh_time'], '%Y-%m-%d %H:%M:%S.%f')
	if datetime.datetime.now() - last_refreshed_time > datetime.timedelta(hours=1):
		url = "https://accounts.spotify.com/api/token"
		data = {'grant_type': 'refresh_token', 'refresh_token': storage['refresh_token'], 'client_id': storage['client_id'], 'client_secret': storage['client_secret']}
        def on_complete(req):
            if req.status == 200 or req.status == 0:
                document <= "Access token refreshed!"
                storage['access_token'] = json.loads(req.text)['access_token']
                #document <= str(json.loads(req.text)['access_token'])
            else:
                 document <= "Error in token refresh!"
		
        req = ajax.Ajax()
        req.bind('complete', on_complete)
		# send a POST request to the url
        req.open('POST', url, False) #<--asyncronous
		# send data as a dictionary
        req.set_header('content-type', 'application/x-www-form-urlencoded')
        req.send(data)

def getTrackInfo(url, params): #Returns a dictionary based on the json response
	#refreshAccessToken() #See if the access token is valid
    authenticateUser()
	
	#Get access_token
    oauth_id = storage['access_token']

	#response_dict = response.json()
    def on_complete(req):
	    if req.status == 200 or req.status == 0:
	        #document["result"].html = req.text
			document <= str(json.loads(req.text))
		#else:
		#	document <= "Error:" + str(json.loads(req.text))

	#url = "https://api.spotify.com/v1/audio-features/3Wv6AagA0qqWH7nRDrkgh7"
    req = ajax.Ajax()
    req.bind('complete', on_complete)
	# send a POST request to the url
    req.open('GET', url, True) #<--asyncronous
    req.set_header("Authorization", "Bearer " + oauth_id)
	# send data as a dictionary
    req.send()

track_id = "3Wv6AagA0qqWH7nRDrkgh7"
getTrackInfo("https://api.spotify.com/v1/audio-features/" + track_id, {})
#document <= str(doc)

calc = html.TABLE()
calc <= html.TR(html.TH(html.DIV("0", id="result"), colspan=3) +
                html.TD("C"))
lines = ["789/", "456*", "123-", "0.=+"]

calc <= (html.TR(html.TD(x) for x in line) for line in lines)

document <= calc

result = document["result"] # direct acces to an element by its id

def action(event):
    """Handles the "click" event on a button of the calculator."""
    # The element the user clicked on is the attribute "target" of the
    # event object
    element = event.target
    # The text printed on the button is the element's "text" attribute
    value = element.text
    if value not in "=C":
        # update the result zone
        if result.text in ["0", "error"]:
            result.text = value
        else:
            result.text = result.text + value
    elif value == "C":
        # reset
        result.text = "0"
    elif value == "=":
        # execute the formula in result zone
        try:
            result.text = eval(result.text)
        except:
            result.text = "error"

# Associate function action() to the event "click" on all buttons
for button in document.select("td"):
    button.bind("click", action)

</script>

<style>
*{
    font-family: sans-serif;
    font-weight: normal;
    font-size: 1.1em;
}
td{
    background-color: #ccc;
    padding: 10px 30px 10px 30px;
    border-radius: 0.2em;
    text-align: center;
}
result{
    border-color: #000;
    border-width: 1px;
    border-style: solid;
    padding: 10px 30px 10px 30px;
    text-align: right;
}
</style>

</body>

</html>
